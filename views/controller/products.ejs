<div class="page-header">
    <h1>Product Manage</h1>
    <p>Total Products:
        <%= counter %>
    </p>
    <% if(type != 'database') { %>
        <a id="sync_button" class="btn btn-primary btn-sm" href="#">Synchronize</a>
        <% } else { %>
            <a id="update_button" class="btn btn-success btn-sm" href="#">Update</a>
            <% } %>
                <a id="remove_all" href="/controller/product/remove_all/" class="btn btn-danger btn-sm pull-right">Remove all</a>
</div>

<table id="product_table" class="table table-striped table-bordered table-hover" cellspacing="0" width="100%">
    <thead>
        <tr>
            <th>Image</th>
            <th>ID</th>
            <th>Num.</th>
            <th>EAN</th>
            <th>Brand</th>
            <th>Title</th>
            <th>Shop</th>
            <th>Price</th>
            <th>Ship</th>
            <th>Link</th>
            <th>Category</th>
            <th>Translated</th>
        </tr>
    </thead>
    <tfoot>
        <tr>
            <th>Image</th>
            <th>ID</th>
            <th>Num.</th>
            <th>EAN</th>
            <th>Brand</th>
            <th>Title</th>
            <th>Shop</th>
            <th>Price</th>
            <th>Ship</th>
            <th>Link</th>
            <th>Category</th>
            <th>Translated</th>
        </tr>
    </tfoot>

    <tbody>
        <% products.forEach(function(product, index) { %>
            <tr class='clickable-row' data-href='/controller/product/edit?product_id=<%= product.product_id %>'>
                <td>
                    <img src="<%= product.image90 %>">
                </td>
                <td>
                    <%= product.product_id %>
                </td>
                <td>
                    <%= product.article_num %>
                </td>
                <td>
                    <%= product.ean %>
                </td>
                <td>
                    <%= product.brand %>
                </td>
                <td>
                    <%= product.title %>
                </td>
                <td>
                    <%= product.shop_name %>
                </td>
                <td>
                    <%= product.price %>
                </td>
                <td>
                    <%= product.shipping %>
                </td>
                <td>
                    <a href="<%= product.link %>">Product Link</a>
                </td>
                <td>
                    <%= product.category_path %>
                </td>
                <td>
                    <% if (product.tranlated) { %>
                        <span class="label label-primary">Translated</span>
                        <% } else { %>
                            <span class="label label-warning">Not Translated</span>
                            <% } %>
                </td>
            </tr>
            <% }) %>
    </tbody>
</table>

<div class="modal fade" id="processing_modal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="myModalLabel">Synchronizing</h4>
            </div>
            <div class="modal-body">
                <div class="progress">
                    <div id="progress_bar" class="progress-bar progress-bar-success progress-bar-striped active" role="progressbar" style="width: 0%">
                        0%
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button id="done_button" type="button" class="btn btn-default" data-dismiss="modal">Done</button>
            </div>
        </div>
    </div>
</div>


<script>
    $(document).ready(function() {
        var socket = io.connect('http://localhost:3000/sync');

        socket.on('sync_process', function(data) {
            console.log(data);
        });

        var dt = $('#product_table').DataTable({
            stateSave: true,
            lengthMenu: [
                [10, 25, 50, -1],
                [10, 25, 50, "All"]
            ],
            order: [
                [1, "asc"]
            ]
        });

        $("#remove_all").click(function(event) {
            if (!confirm('Remove All products?ÔºÅ')) {
                event.preventDefault();
            }
        });

        $('#sync_button').click(function(event) {
            $('#done_button').hide();
            $('#processing_modal').modal({
                backdrop: 'static',
                keyboard: false
            });
            socket.emit('sync', {
                id: "<%= id %>",
                type: "<%= type %>"
            });
            socket.on('sync_process', function(data){
                setProgressBar(data.currentpage / data.totalpage);             
            });
            socket.on('sync_finished', function(data){
                $("#progress_bar").html("Synchronizing finished! More than "+data.count+" Products added in Database.");
                $('#done_button').fadeIn();
            });
        });

        <% if(type == 'database') { %>
        $('#product_table').on('click', 'tr', function() {
            var url = $(this).data('href');
            window.location.href = $(this).data('href');
        });
        <% } %>
            
        function setProgressBar(value) {
            var _value = (value * 100).toFixed(2)+"%";
            $("#progress_bar").width(_value);
            $("#progress_bar").html(_value);
        }
    });

</script>
